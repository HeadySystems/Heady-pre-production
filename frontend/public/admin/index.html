<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heady Admin IDE</title>
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0f; color: #e0e0e0; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 240px; background: #111; border-right: 1px solid #333; overflow-y: auto; }
    .sidebar h3 { margin: 0; padding: 12px 16px; background: #1a1a2e; color: #fff; font-size: 14px; }
    .file-tree { padding: 8px 0; }
    .file-item { padding: 6px 16px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .file-item:hover { background: #1f1f3a; }
    .file-item.selected { background: #2a2a4e; }
    .main { flex: 1; display: flex; flex-direction: column; }
    .tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
    .tab { padding: 8px 16px; cursor: pointer; font-size: 13px; border-right: 1px solid #333; }
    .tab:hover { background: #1f1f3a; }
    .tab.active { background: #2a2a4e; }
    .editor-container { flex: 1; position: relative; }
    .panel-right { width: 360px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; }
    .panel-header { padding: 12px 16px; background: #1a1a2e; font-size: 14px; font-weight: 600; }
    .panel-body { flex: 1; overflow-y: auto; padding: 12px; font-size: 13px; }
    .logs { background: #0a0a0f; font-family: 'Consolas', 'Monaco', monospace; font-size: 11px; white-space: pre-wrap; padding: 8px; border: 1px solid #333; border-radius: 4px; max-height: 240px; overflow-y: auto; }
    .log-line { margin: 0; }
    .log-line.error { color: #f66; }
    .log-line.success { color: #6f6; }
    .log-line.warn { color: #fc3; }
    .log-line.info { color: #6cf; }
    .status-bar { display: flex; justify-content: space-between; padding: 4px 12px; background: #111; border-top: 1px solid #333; font-size: 11px; }
    .btn { padding: 6px 12px; background: #2a2a4e; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #3a3a5e; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .input { padding: 6px 8px; background: #1a1a2e; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
    .settings-group { margin-bottom: 16px; }
    .settings-group label { display: block; margin-bottom: 4px; font-size: 12px; }
    .settings-group input, .settings-group select { width: 100%; padding: 6px 8px; background: #1a1a2e; color: #fff; border: 1px solid #444; border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const API_BASE = '/api/admin';
    const HEADY_API_KEY = localStorage.getItem('headyApiKey') || prompt('Enter HEADY_API_KEY:');
    if (HEADY_API_KEY) localStorage.setItem('headyApiKey', HEADY_API_KEY);

    function apiCall(path, options = {}) {
      const url = `${API_BASE}${path}`;
      const opts = {
        headers: {
          'Content-Type': 'application/json',
          'x-heady-api-key': HEADY_API_KEY,
          ...options.headers,
        },
        ...options,
      };
      return fetch(url, opts).then(r => {
        if (!r.ok) throw new Error(`API error: ${r.status}`);
        return r.json();
      });
    }

    function useSSE(url, onMessage) {
      const [active, setActive] = useState(false);
      useEffect(() => {
        if (!url || !active) return;
        const es = new EventSource(url);
        es.onmessage = e => {
          const data = JSON.parse(e.data);
          onMessage(data);
        };
        es.onerror = () => {
          es.close();
          setActive(false);
        };
        return () => es.close();
      }, [url, active]);
      return { setActive };
    }

    function FileTree({ onSelect, selectedPath }) {
      const [roots, setRoots] = useState([]);
      const [tree, setTree] = useState({});
      const [expanded, setExpanded] = useState({});

      useEffect(() => {
        apiCall('/roots').then(r => setRoots(r.roots));
      }, []);

      const loadDir = useCallback(async (root, path) => {
        const res = await apiCall(`/files?root=${root.id}&path=${encodeURIComponent(path)}`);
        setTree(prev => ({ ...prev, [`${root.id}:${path}`]: res.entries }));
      }, []);

      const toggle = useCallback((root, path) => {
        const key = `${root.id}:${path}`;
        setExpanded(prev => ({ ...prev, [key]: !prev[key] }));
        if (!expanded[key]) loadDir(root, path);
      }, [expanded, loadDir]);

      const renderTree = (root, path = '', depth = 0) => {
        const key = `${root.id}:${path}`;
        const entries = tree[key] || [];
        return entries.map(item => {
          const fullPath = path ? `${path}/${item.path}` : item.path;
          const isSelected = selectedPath === fullPath;
          if (item.type === 'directory') {
            return (
              <div key={fullPath}>
                <div className="file-item" style={{ paddingLeft: 8 + depth * 16 }} onClick={() => toggle(root, fullPath)}>
                  <span>{expanded[key] ? 'üìÇ' : 'üìÅ'}</span> {item.name}
                </div>
                {expanded[key] && renderTree(root, fullPath, depth + 1)}
              </div>
            );
          }
          return (
            <div key={fullPath} className={`file-item ${isSelected ? 'selected' : ''}`} style={{ paddingLeft: 8 + depth * 16 }} onClick={() => onSelect(root, fullPath, item)}>
              <span>üìÑ</span> {item.name}
            </div>
          );
        });
      };

      return (
        <div>
          <h3>Explorer</h3>
          <div className="file-tree">
            {roots.map(root => (
              <div key={root.id}>
                <div className="file-item" onClick={() => toggle(root, '')}>
                  <span>{expanded[`${root.id}:`] ? 'üìÇ' : 'üìÅ'}</span> {root.label}
                </div>
                {expanded[`${root.id}:`] && renderTree(root, '', 0)}
              </div>
            ))}
          </div>
        </div>
      );
    }

    function Editor({ file, onSave }) {
      const editorRef = useRef();
      const [editor, setEditor] = useState(null);

      useEffect(() => {
        if (!editorRef.current) return;
        require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
        require(['vs/editor/editor.main'], () => {
          const monaco = window.monaco;
          const ed = monaco.editor.create(editorRef.current, {
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: false },
            scrollBeyondLastLine: false,
          });
          setEditor(ed);
          return () => ed.dispose();
        });
      }, []);

      useEffect(() => {
        if (!editor || !file) return;
        const model = editor.getModel();
        if (model) model.dispose();
        const uri = new window.monaco.Uri.parse(`file:///${file.path}`);
        const lang = file.path.endsWith('.py') ? 'python' : file.path.endsWith('.json') ? 'json' : file.path.endsWith('.yaml') || file.path.endsWith('.yml') ? 'yaml' : 'plaintext';
        const newModel = window.monaco.editor.createModel(file.content, lang, uri);
        editor.setModel(newModel);
      }, [editor, file]);

      const handleSave = useCallback(() => {
        if (!editor || !file) return;
        const content = editor.getValue();
        onSave(file.root, file.path, content, file.sha);
      }, [editor, file]);

      useEffect(() => {
        const handleKey = e => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            handleSave();
          }
        };
        window.addEventListener('keydown', handleKey);
        return () => window.removeEventListener('keydown', handleKey);
      }, [handleSave]);

      return (
        <div className="editor-container">
          <div ref={editorRef} style={{ width: '100%', height: '100%' }} />
        </div>
      );
    }

    function Tabs({ tabs, active, onSelect, onClose }) {
      return (
        <div className="tabs">
          {tabs.map(tab => (
            <div key={tab.path} className={`tab ${active === tab.path ? 'active' : ''}`} onClick={() => onSelect(tab)}>
              {tab.name}
              <span style={{ marginLeft: 8, cursor: 'pointer' }} onClick={e => { e.stopPropagation(); onClose(tab); }}>‚úï</span>
            </div>
          ))}
        </div>
      );
    }

    function Logs() {
      const [logs, setLogs] = useState([]);
      const [ops, setOps] = useState([]);
      const [selectedOp, setSelectedOp] = useState(null);
      const [streamUrl, setStreamUrl] = useState(null);
      const { setActive } = useSSE(streamUrl, data => {
        if (data.event === 'log') setLogs(prev => [...prev.slice(-200), data.data]);
        if (data.event === 'status') console.log('Status:', data.data);
        if (data.event === 'end') console.log('Stream ended');
      });

      useEffect(() => {
        apiCall('/ops').then(r => setOps(r.ops));
      }, []);

      const startBuild = useCallback(async () => {
        const res = await apiCall('/build', { method: 'POST', body: JSON.stringify({}) });
        setSelectedOp(res.op);
        setStreamUrl(res.streamUrl);
        setActive(true);
      }, []);

      const startAudit = useCallback(async () => {
        const res = await apiCall('/audit', { method: 'POST', body: JSON.stringify({}) });
        setSelectedOp(res.op);
        setStreamUrl(res.streamUrl);
        setActive(true);
      }, []);

      return (
        <div>
          <div className="panel-header">Operations</div>
          <div className="panel-body">
            <div style={{ marginBottom: 12 }}>
              <button className="btn" onClick={startBuild}>Run Build</button>
              <button className="btn" onClick={startAudit} style={{ marginLeft: 8 }}>Run Audit</button>
            </div>
            {selectedOp && (
              <div style={{ marginBottom: 12 }}>
                <strong>Operation:</strong> {selectedOp.type} ({selectedOp.status})
              </div>
            )}
            <div className="logs">
              {logs.map((log, i) => (
                <div key={i} className={`log-line ${log.level}`}>{log.line}</div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function Settings() {
      const [gpuHost, setGpuHost] = useState('');
      const [gpuPort, setGpuPort] = useState('');
      const [gpuMemLimit, setGpuMemLimit] = useState('');
      const [gpuEnabled, setGpuEnabled] = useState(false);

      const save = useCallback(() => {
        localStorage.setItem('gpuHost', gpuHost);
        localStorage.setItem('gpuPort', gpuPort);
        localStorage.setItem('gpuMemLimit', gpuMemLimit);
        localStorage.setItem('gpuEnabled', gpuEnabled);
        alert('Settings saved (local only for now)');
      }, [gpuHost, gpuPort, gpuMemLimit, gpuEnabled]);

      useEffect(() => {
        setGpuHost(localStorage.getItem('gpuHost') || '');
        setGpuPort(localStorage.getItem('gpuPort') || '');
        setGpuMemLimit(localStorage.getItem('gpuMemLimit') || '');
        setGpuEnabled(localStorage.getItem('gpuEnabled') === 'true');
      }, []);

      return (
        <div>
          <div className="panel-header">Settings</div>
          <div className="panel-body">
            <div className="settings-group">
              <label>Remote GPU Host</label>
              <input className="input" value={gpuHost} onChange={e => setGpuHost(e.target.value)} placeholder="e.g. gpu.example.com" />
            </div>
            <div className="settings-group">
              <label>Remote GPU Port</label>
              <input className="input" value={gpuPort} onChange={e => setGpuPort(e.target.value)} placeholder="e.g. 4000" />
            </div>
            <div className="settings-group">
              <label>GPU Memory Limit (MB)</label>
              <input className="input" value={gpuMemLimit} onChange={e => setGpuMemLimit(e.target.value)} placeholder="e.g. 8192" />
            </div>
            <div className="settings-group">
              <label>
                <input type="checkbox" checked={gpuEnabled} onChange={e => setGpuEnabled(e.target.checked)} /> Enable Remote GPU (GPUDirect RDMA)
              </label>
            </div>
            <button className="btn" onClick={save}>Save Settings</button>
          </div>
        </div>
      );
    }

    function App() {
      const [tabs, setTabs] = useState([]);
      const [activeTab, setActiveTab] = useState(null);
      const [selectedFile, setSelectedFile] = useState(null);
      const [activePanel, setActivePanel] = useState('logs');

      const openFile = useCallback(async (root, path, meta) => {
        const existing = tabs.find(t => t.path === path);
        if (existing) {
          setActiveTab(path);
          setSelectedFile(existing);
          return;
        }
        const res = await apiCall(`/file?root=${root.id}&path=${encodeURIComponent(path)}`);
        const tab = { root, path, name: meta.name, ...res };
        setTabs(prev => [...prev, tab]);
        setActiveTab(path);
        setSelectedFile(tab);
      }, [tabs]);

      const closeTab = useCallback(tab => {
        setTabs(prev => prev.filter(t => t.path !== tab.path));
        if (activeTab === tab.path) {
          const idx = tabs.findIndex(t => t.path === tab.path);
          const next = tabs[idx + 1] || tabs[idx - 1];
          if (next) {
            setActiveTab(next.path);
            setSelectedFile(next);
          } else {
            setActiveTab(null);
            setSelectedFile(null);
          }
        }
      }, [tabs, activeTab]);

      const saveFile = useCallback(async (root, path, content, expectedSha) => {
        await apiCall('/file', {
          method: 'POST',
          body: JSON.stringify({ root: root.id, path, content, expectedSha }),
        });
        // Update tab sha
        setTabs(prev => prev.map(t => t.path === path ? { ...t, sha: 'updated', content } : t));
        if (selectedFile && selectedFile.path === path) {
          setSelectedFile(prev => ({ ...prev, sha: 'updated', content }));
        }
      }, [selectedFile]);

      return (
        <div className="app">
          <div className="sidebar">
            <FileTree onSelect={openFile} selectedPath={selectedFile?.path || ''} />
          </div>
          <div className="main">
            <Tabs tabs={tabs} active={activeTab} onSelect={setSelectedFile} onClose={closeTab} />
            {selectedFile ? <Editor file={selectedFile} onSave={saveFile} /> : <div style={{ padding: 20, color: '#888' }}>Open a file to start editing</div>}
            <div className="status-bar">
              <span>{selectedFile ? `${selectedFile.path} (${selectedFile.bytes} bytes)` : 'No file'}</span>
              <span>Heady Admin IDE</span>
            </div>
          </div>
          <div className="panel-right">
            {activePanel === 'logs' && <Logs />}
            {activePanel === 'settings' && <Settings />}
            <div style={{ display: 'flex', borderTop: '1px solid #333' }}>
              <button className="btn" style={{ flex: 1, borderRadius: 0 }} onClick={() => setActivePanel('logs')}>Logs</button>
              <button className="btn" style={{ flex: 1, borderRadius: 0 }} onClick={() => setActivePanel('settings')}>Settings</button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
