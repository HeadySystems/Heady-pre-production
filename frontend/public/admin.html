<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heady Admin UI</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@monaco-editor/loader@1.4.0/lib/esm/monaco-loader.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #22d3ee;
            --bg-dark: #0f172a;
            --bg-medium: #1e293b;
            --bg-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f3a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            border-radius: var(--radius);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
            background: rgba(99, 102, 241, 0.1);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius) var(--radius) 0 0;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab:hover {
            background: var(--bg-light);
            color: var(--text-primary);
        }
        
        .tab.active:hover {
            background: var(--primary-dark);
        }
        
        .content {
            background: var(--bg-medium);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
            min-height: 400px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-danger {
            background: var(--error);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: var(--bg-dark);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status.online {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }
        
        .log-container {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .log-line {
            margin-bottom: 2px;
            white-space: pre-wrap;
        }
        
        .log-line.info {
            color: var(--text-secondary);
        }
        
        .log-line.error {
            color: var(--error);
        }
        
        .log-line.success {
            color: var(--success);
        }
        
        .file-browser {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        
        .file-item:hover {
            background: var(--bg-light);
        }
        
        .file-item.selected {
            background: rgba(99, 102, 241, 0.2);
            border-left: 3px solid var(--primary);
        }
        
        .file-icon {
            margin-right: 10px;
            opacity: 0.7;
        }
        
        .editor-container {
            height: 500px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-secondary);
        }
        
        .spinner {
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--error);
        }
        
        .toast.info {
            background: var(--primary);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // API client
        const API = {
            async request(endpoint, options = {}) {
                const apiKey = localStorage.getItem('heady_api_key') || prompt('Enter Heady API Key:');
                if (apiKey) {
                    localStorage.setItem('heady_api_key', apiKey);
                }
                
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        'x-heady-api-key': apiKey,
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            },
            
            async get(endpoint) {
                return this.request(endpoint);
            },
            
            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }
        };
        
        // Toast notification
        function Toast({ message, type, onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            
            return (
                <div className={`toast ${type}`}>
                    {message}
                </div>
            );
        }
        
        // File browser component
        function FileBrowser({ onFileSelect }) {
            const [files, setFiles] = useState([]);
            const [currentPath, setCurrentPath] = useState('/');
            const [loading, setLoading] = useState(false);
            
            useEffect(() => {
                loadFiles(currentPath);
            }, [currentPath]);
            
            async function loadFiles(path) {
                setLoading(true);
                try {
                    const data = await API.get(`/api/admin/files?path=${encodeURIComponent(path)}`);
                    setFiles(data.files || []);
                } catch (error) {
                    console.error('Failed to load files:', error);
                } finally {
                    setLoading(false);
                }
            }
            
            function handleFileClick(file) {
                if (file.type === 'directory') {
                    setCurrentPath(file.path);
                } else {
                    onFileSelect(file.path);
                }
            }
            
            function navigateUp() {
                if (currentPath !== '/') {
                    const parentPath = currentPath.split('/').slice(0, -1).join('/') || '/';
                    setCurrentPath(parentPath);
                }
            }
            
            return (
                <div className="file-browser">
                    <div style={{ marginBottom: '15px' }}>
                        <button className="btn btn-secondary" onClick={navigateUp} disabled={currentPath === '/'}>
                            ‚Üë Up
                        </button>
                        <span style={{ marginLeft: '10px', color: 'var(--text-secondary)' }}>
                            {currentPath}
                        </span>
                    </div>
                    
                    {loading ? (
                        <div className="loading">
                            <div className="spinner"></div>
                            Loading...
                        </div>
                    ) : (
                        <div>
                            {files.map(file => (
                                <div key={file.path} className="file-item" onClick={() => handleFileClick(file)}>
                                    <span className="file-icon">
                                        {file.type === 'directory' ? 'üìÅ' : 'üìÑ'}
                                    </span>
                                    <span>{file.name}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        // Log viewer component
        function LogViewer({ operationId }) {
            const [logs, setLogs] = useState([]);
            const [isStreaming, setIsStreaming] = useState(false);
            const eventSourceRef = useRef(null);
            
            useEffect(() => {
                if (!operationId) return;
                
                setIsStreaming(true);
                setLogs([]);
                
                const eventSource = new EventSource(`/api/admin/ops/${operationId}/stream`);
                eventSourceRef.current = eventSource;
                
                eventSource.onmessage = (event) => {
                    const logEntry = JSON.parse(event.data);
                    setLogs(prev => [...prev, logEntry]);
                };
                
                eventSource.onerror = () => {
                    setIsStreaming(false);
                    eventSource.close();
                };
                
                eventSource.onclose = () => {
                    setIsStreaming(false);
                };
                
                return () => {
                    if (eventSourceRef.current) {
                        eventSourceRef.current.close();
                    }
                };
            }, [operationId]);
            
            return (
                <div className="log-container">
                    {logs.length === 0 && !isStreaming && (
                        <div style={{ textAlign: 'center', color: 'var(--text-secondary)' }}>
                            No logs available
                        </div>
                    )}
                    {logs.map((log, index) => (
                        <div key={index} className={`log-line ${log.level || 'info'}`}>
                            [{log.timestamp}] {log.message}
                        </div>
                    ))}
                    {isStreaming && (
                        <div className="log-line info">
                            <div className="spinner" style={{ display: 'inline-block', width: '10px', height: '10px', marginRight: '5px' }}></div>
                            Streaming logs...
                        </div>
                    )}
                </div>
            );
        }
        
        // Configuration editor component
        function ConfigEditor() {
            const [config, setConfig] = useState({
                renderYaml: '',
                mcpConfig: '',
                envVars: {}
            });
            const [loading, setLoading] = useState(false);
            const [saving, setSaving] = useState(false);
            
            useEffect(() => {
                loadConfig();
            }, []);
            
            async function loadConfig() {
                setLoading(true);
                try {
                    // Load render.yaml and mcp_config.json content
                    const [renderData, mcpData] = await Promise.all([
                        API.get('/api/admin/file?path=render.yaml'),
                        API.get('/api/admin/file?path=mcp_config.json')
                    ]);
                    
                    setConfig({
                        renderYaml: renderData.content || '',
                        mcpConfig: mcpData.content || '',
                        envVars: renderData.envVars || {}
                    });
                } catch (error) {
                    console.error('Failed to load config:', error);
                } finally {
                    setLoading(false);
                }
            }
            
            async function saveConfig() {
                setSaving(true);
                try {
                    await Promise.all([
                        API.post('/api/admin/file', {
                            path: 'render.yaml',
                            content: config.renderYaml
                        }),
                        API.post('/api/admin/file', {
                            path: 'mcp_config.json',
                            content: config.mcpConfig
                        })
                    ]);
                    
                    showToast('Configuration saved successfully', 'success');
                } catch (error) {
                    showToast('Failed to save configuration', 'error');
                    console.error('Save error:', error);
                } finally {
                    setSaving(false);
                }
            }
            
            return (
                <div>
                    <div className="grid">
                        <div className="card">
                            <h3>Render Configuration</h3>
                            <textarea
                                value={config.renderYaml}
                                onChange={(e) => setConfig(prev => ({ ...prev, renderYaml: e.target.value }))}
                                placeholder="render.yaml content..."
                                rows={15}
                                style={{ fontFamily: 'monospace', fontSize: '12px' }}
                            />
                        </div>
                        
                        <div className="card">
                            <h3>MCP Configuration</h3>
                            <textarea
                                value={config.mcpConfig}
                                onChange={(e) => setConfig(prev => ({ ...prev, mcpConfig: e.target.value }))}
                                placeholder="mcp_config.json content..."
                                rows={15}
                                style={{ fontFamily: 'monospace', fontSize: '12px' }}
                            />
                        </div>
                    </div>
                    
                    <div style={{ marginTop: '20px', textAlign: 'center' }}>
                        <button className="btn btn-success" onClick={saveConfig} disabled={saving}>
                            {saving ? 'Saving...' : 'Save Configuration'}
                        </button>
                    </div>
                </div>
            );
        }
        
        // GPU Settings component
        function GpuSettings() {
            const [gpuConfig, setGpuConfig] = useState({
                enabled: false,
                remoteHost: '',
                remotePort: '',
                memoryLimit: '',
                enableGpuDirect: false
            });
            const [loading, setLoading] = useState(false);
            const [testing, setTesting] = useState(false);
            
            useEffect(() => {
                loadGpuConfig();
            }, []);
            
            async function loadGpuConfig() {
                setLoading(true);
                try {
                    const data = await API.get('/api/admin/gpu-status');
                    setGpuConfig({
                        enabled: data.enabled || false,
                        remoteHost: data.remoteHost || '',
                        remotePort: data.remotePort || '',
                        memoryLimit: data.memoryLimit || '',
                        enableGpuDirect: data.enableGpuDirect || false
                    });
                } catch (error) {
                    console.error('Failed to load GPU config:', error);
                } finally {
                    setLoading(false);
                }
            }
            
            async function testGpuConnection() {
                setTesting(true);
                try {
                    const result = await API.post('/api/hf/infer', {
                        inputs: 'test connection',
                        model: 'gpu-test'
                    });
                    showToast('GPU connection test successful', 'success');
                } catch (error) {
                    showToast('GPU connection test failed', 'error');
                    console.error('GPU test error:', error);
                } finally {
                    setTesting(false);
                }
            }
            
            return (
                <div className="card">
                    <h3>GPU Settings</h3>
                    
                    {loading ? (
                        <div className="loading">
                            <div className="spinner"></div>
                            Loading GPU configuration...
                        </div>
                    ) : (
                        <div>
                            <div className="form-group">
                                <label>
                                    <input
                                        type="checkbox"
                                        checked={gpuConfig.enabled}
                                        onChange={(e) => setGpuConfig(prev => ({ ...prev, enabled: e.target.checked }))}
                                    />
                                    Enable GPU Acceleration
                                </label>
                            </div>
                            
                            {gpuConfig.enabled && (
                                <>
                                    <div className="form-group">
                                        <label>Remote GPU Host</label>
                                        <input
                                            type="text"
                                            value={gpuConfig.remoteHost}
                                            onChange={(e) => setGpuConfig(prev => ({ ...prev, remoteHost: e.target.value }))}
                                            placeholder="gpu.example.com"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Remote GPU Port</label>
                                        <input
                                            type="text"
                                            value={gpuConfig.remotePort}
                                            onChange={(e) => setGpuConfig(prev => ({ ...prev, remotePort: e.target.value }))}
                                            placeholder="8080"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>Memory Limit (MB)</label>
                                        <input
                                            type="text"
                                            value={gpuConfig.memoryLimit}
                                            onChange={(e) => setGpuConfig(prev => ({ ...prev, memoryLimit: e.target.value }))}
                                            placeholder="8192"
                                        />
                                    </div>
                                    
                                    <div className="form-group">
                                        <label>
                                            <input
                                                type="checkbox"
                                                checked={gpuConfig.enableGpuDirect}
                                                onChange={(e) => setGpuConfig(prev => ({ ...prev, enableGpuDirect: e.target.checked }))}
                                            />
                                            Enable GPUDirect RDMA
                                        </label>
                                    </div>
                                    
                                    <button className="btn btn-secondary" onClick={testGpuConnection} disabled={testing}>
                                        {testing ? 'Testing...' : 'Test Connection'}
                                    </button>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        }
        
        // Main application
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedFile, setSelectedFile] = useState(null);
            const [operationId, setOperationId] = useState(null);
            const [toasts, setToasts] = useState([]);
            
            function showToast(message, type = 'info') {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
            }
            
            function removeToast(id) {
                setToasts(prev => prev.filter(toast => toast.id !== id));
            }
            
            async function runBuild() {
                try {
                    const result = await API.post('/api/admin/build');
                    setOperationId(result.operationId);
                    setActiveTab('logs');
                    showToast('Build started', 'success');
                } catch (error) {
                    showToast('Failed to start build', 'error');
                    console.error('Build error:', error);
                }
            }
            
            async function runAudit() {
                try {
                    const result = await API.post('/api/admin/audit');
                    setOperationId(result.operationId);
                    setActiveTab('logs');
                    showToast('Audit started', 'success');
                } catch (error) {
                    showToast('Failed to start audit', 'error');
                    console.error('Audit error:', error);
                }
            }
            
            return (
                <div className="container">
                    <div className="header">
                        <h1>Heady Admin UI</h1>
                        <p style={{ color: 'var(--text-secondary)' }}>
                            System Management & Configuration Interface
                        </p>
                    </div>
                    
                    <div className="tabs">
                        <button className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>
                            Dashboard
                        </button>
                        <button className={`tab ${activeTab === 'files' ? 'active' : ''}`} onClick={() => setActiveTab('files')}>
                            Files
                        </button>
                        <button className={`tab ${activeTab === 'config' ? 'active' : ''}`} onClick={() => setActiveTab('config')}>
                            Configuration
                        </button>
                        <button className={`tab ${activeTab === 'gpu' ? 'active' : ''}`} onClick={() => setActiveTab('gpu')}>
                            GPU Settings
                        </button>
                        <button className={`tab ${activeTab === 'logs' ? 'active' : ''}`} onClick={() => setActiveTab('logs')}>
                            Logs
                        </button>
                    </div>
                    
                    <div className="content">
                        {activeTab === 'dashboard' && (
                            <div>
                                <div className="grid">
                                    <div className="card">
                                        <h3>System Status</h3>
                                        <div style={{ marginBottom: '15px' }}>
                                            <span className="status online">Online</span>
                                        </div>
                                        <p>Heady Manager is running and responsive</p>
                                    </div>
                                    
                                    <div className="card">
                                        <h3>Quick Actions</h3>
                                        <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                                            <button className="btn btn-success" onClick={runBuild}>
                                                Run Build
                                            </button>
                                            <button className="btn btn-warning" onClick={runAudit}>
                                                Run Audit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="card" style={{ marginTop: '20px' }}>
                                    <h3>System Information</h3>
                                    <div className="grid">
                                        <div>
                                            <strong>Node.js Version:</strong> {process.version || 'Unknown'}
                                        </div>
                                        <div>
                                            <strong>Platform:</strong> {navigator.platform}
                                        </div>
                                        <div>
                                            <strong>Time:</strong> {new Date().toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'files' && (
                            <div className="grid">
                                <div>
                                    <FileBrowser onFileSelect={setSelectedFile} />
                                </div>
                                <div>
                                    {selectedFile && (
                                        <div>
                                            <h3>Editor: {selectedFile}</h3>
                                            <div className="editor-container" id="monaco-editor">
                                                {/* Monaco editor will be initialized here */}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'config' && <ConfigEditor />}
                        
                        {activeTab === 'gpu' && <GpuSettings />}
                        
                        {activeTab === 'logs' && (
                            <div>
                                <h3>Operation Logs</h3>
                                {operationId ? (
                                    <LogViewer operationId={operationId} />
                                ) : (
                                    <div style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '40px' }}>
                                        No operation running. Start a build or audit to see logs.
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {toasts.map(toast => (
                        <Toast
                            key={toast.id}
                            message={toast.message}
                            type={toast.type}
                            onClose={() => removeToast(toast.id)}
                        />
                    ))}
                </div>
            );
        }
        
        // Initialize Monaco Editor when files tab is selected
        useEffect(() => {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.target.id === 'monaco-editor') {
                        const editorContainer = document.getElementById('monaco-editor');
                        if (editorContainer && !editorContainer.dataset.initialized) {
                            editorContainer.dataset.initialized = 'true';
                            import('https://unpkg.com/@monaco-editor/react@4.6.0/lib/es/index.js').then(() => {
                                // Monaco Editor would be initialized here
                                editorContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Monaco Editor placeholder<br />File editing capabilities</div>';
                            });
                        }
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
            
            return () => observer.disconnect();
        });
        
        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
